


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ItemServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ru.practicum.shareit.item</a>
</div>

<h1>Coverage Summary for Class: ItemServiceImpl (ru.practicum.shareit.item)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ItemServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    71,4%
  </span>
  <span class="absValue">
    (100/140)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ru.practicum.shareit.item;
&nbsp;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import ru.practicum.shareit.DateUtils;
&nbsp;import ru.practicum.shareit.booking.BookingRepository;
&nbsp;import ru.practicum.shareit.booking.dto.BookingShortInfoDto;
&nbsp;import ru.practicum.shareit.booking.model.Booking;
&nbsp;import ru.practicum.shareit.booking.model.enums.Status;
&nbsp;import ru.practicum.shareit.exceptions.*;
&nbsp;import ru.practicum.shareit.item.dto.CommentDto;
&nbsp;import ru.practicum.shareit.item.dto.ItemDto;
&nbsp;import ru.practicum.shareit.item.model.Comment;
&nbsp;import ru.practicum.shareit.item.model.Item;
&nbsp;import ru.practicum.shareit.user.User;
&nbsp;import ru.practicum.shareit.user.UserServiceImpl;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@AllArgsConstructor
&nbsp;public class ItemServiceImpl implements ItemService {
&nbsp;    private final ItemRepository itemRepository;
&nbsp;
&nbsp;    private final BookingRepository bookingRepository;
&nbsp;
&nbsp;    private final UserServiceImpl userService;
&nbsp;
&nbsp;    private final CommentRepository commentRepository;
&nbsp;
&nbsp;    @Override
&nbsp;    public ItemDto addItem(Long userId, ItemDto itemDto) {
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getName() == null) {</b>
<b class="fc">&nbsp;            log.warn(&quot;Name is null!&quot;);</b>
<b class="fc">&nbsp;            throw new NullValidationException(&quot;Name&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getName().isBlank()) {</b>
<b class="fc">&nbsp;            log.warn(&quot;Name is empty!&quot;);</b>
<b class="fc">&nbsp;            throw new ValidationException(&quot;Name is empty!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getAvailable() == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Available is null!&quot;);</b>
<b class="nc">&nbsp;            throw new NullValidationException(&quot;Available&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getDescription() == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Description is null!&quot;);</b>
<b class="nc">&nbsp;            throw new NullValidationException(&quot;Description&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        User user = userService.getUser(userId);</b>
&nbsp;
<b class="fc">&nbsp;        Item item = ItemMapper.toItem(itemDto);</b>
<b class="fc">&nbsp;        item.setOwner(user);</b>
&nbsp;
<b class="fc">&nbsp;        Item addedItem = itemRepository.save(item);</b>
&nbsp;
<b class="fc">&nbsp;        return ItemMapper.toItemDto(addedItem);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ItemDto updateItem(Long userId, ItemDto itemDto) {
<b class="fc">&nbsp;        Item gettedItem = getItem(itemDto.getId());</b>
<b class="fc">&nbsp;        User user = userService.getUser(userId);</b>
&nbsp;
<b class="fc">&nbsp;        if (!gettedItem.getOwner().equals(user)) {</b>
<b class="fc">&nbsp;            log.warn(&quot;Another user!&quot;);</b>
<b class="fc">&nbsp;            throw new ForbiddenException(&quot;Another user!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getName() != null) {</b>
<b class="fc">&nbsp;            gettedItem.setName(itemDto.getName());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getDescription() != null) {</b>
<b class="fc">&nbsp;            gettedItem.setDescription(itemDto.getDescription());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (itemDto.getAvailable() != null) {</b>
<b class="fc">&nbsp;            gettedItem.setAvailable(itemDto.getAvailable());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Item updatedItem = itemRepository.save(gettedItem);</b>
&nbsp;
<b class="fc">&nbsp;        return ItemMapper.toItemDto(updatedItem);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;ItemDto&gt; getItems(Long userId, Integer from, Integer size) {
<b class="fc">&nbsp;        User user = userService.getUser(userId);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;ItemDto&gt; listItemDto = new ArrayList&lt;&gt;();</b>
&nbsp;        List&lt;Item&gt; items;
&nbsp;
<b class="fc">&nbsp;        if ((from != null) &amp;&amp; (size != null)) {</b>
<b class="fc">&nbsp;            if ((from == -1) || (size == -1) || (size == 0)) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Bad range for items!&quot;);</b>
<b class="nc">&nbsp;                throw new ValidationException(&quot;Bad range for items!&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            int newFrom = from / size;</b>
<b class="fc">&nbsp;            Pageable page = PageRequest.of(newFrom, size);</b>
&nbsp;
<b class="fc">&nbsp;            Page&lt;Item&gt; itemssPage = itemRepository.findByOwner(user, page);</b>
&nbsp;
<b class="fc">&nbsp;            items = itemssPage.getContent();</b>
<b class="fc">&nbsp;        } else if ((from == null) &amp;&amp; (size == null)) {</b>
<b class="nc">&nbsp;            items = itemRepository.findByOwner(user);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;Bad range for items!&quot;);</b>
<b class="nc">&nbsp;            throw new ValidationException(&quot;Bad range for items!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        for (Item item : items) {</b>
<b class="fc">&nbsp;            ItemDto itemDto = ItemMapper.toItemDto(item);</b>
&nbsp;
<b class="fc">&nbsp;            List&lt;Comment&gt; comments = commentRepository.findByItem(item);</b>
<b class="fc">&nbsp;            List&lt;CommentDto&gt; commentsDto = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;            for (Comment comment : comments) {</b>
<b class="nc">&nbsp;                CommentDto commentDto = CommentMapper.toCommentDto(comment);</b>
<b class="nc">&nbsp;                commentsDto.add(commentDto);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="fc">&nbsp;            itemDto.setComments(commentsDto);</b>
&nbsp;
<b class="fc">&nbsp;            if (item.getOwner().equals(user)) {</b>
<b class="fc">&nbsp;                itemDto.setLastBooking(findLastBooking(item));</b>
<b class="fc">&nbsp;                itemDto.setNextBooking(findNextBooking(item));</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            listItemDto.add(itemDto);</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return listItemDto;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ItemDto getItemDto(Long userId, Long itemId) {
<b class="fc">&nbsp;        User user = userService.getUser(userId);</b>
<b class="fc">&nbsp;        Item item = getItem(itemId);</b>
&nbsp;
<b class="fc">&nbsp;        ItemDto itemDto = ItemMapper.toItemDto(item);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Comment&gt; comments = commentRepository.findByItem(item);</b>
<b class="fc">&nbsp;        List&lt;CommentDto&gt; commentsDto = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        for (Comment comment : comments) {</b>
<b class="nc">&nbsp;            CommentDto commentDto = CommentMapper.toCommentDto(comment);</b>
&nbsp;
<b class="nc">&nbsp;            commentsDto.add(commentDto);</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        itemDto.setComments(commentsDto);</b>
&nbsp;
<b class="fc">&nbsp;        if (item.getOwner().equals(user)) {</b>
<b class="fc">&nbsp;            itemDto.setLastBooking(findLastBooking(item));</b>
<b class="fc">&nbsp;            itemDto.setNextBooking(findNextBooking(item));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return itemDto;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Item getItem(Long itemId) {
<b class="fc">&nbsp;        Optional&lt;Item&gt; item = itemRepository.findById(itemId);</b>
<b class="fc">&nbsp;        if (item.isPresent()) {</b>
<b class="fc">&nbsp;            return item.get();</b>
&nbsp;        } else {
<b class="fc">&nbsp;            log.warn(&quot;Not found item &quot; + itemId);</b>
<b class="fc">&nbsp;            throw new ItemNotFoundException(itemId);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;ItemDto&gt; search(String query, Integer from, Integer size) {
<b class="fc">&nbsp;        List&lt;ItemDto&gt; listItemDto = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        if ((from != null) &amp;&amp; (size != null)) {</b>
<b class="fc">&nbsp;            if ((from == -1) || (size == -1) || (size == 0)) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Bad range for bookings!&quot;);</b>
<b class="nc">&nbsp;                throw new ValidationException(&quot;Bad range for bookings!&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (!query.isBlank()) {</b>
<b class="fc">&nbsp;                int newFrom = from / size;</b>
<b class="fc">&nbsp;                Pageable page = PageRequest.of(newFrom, size);</b>
&nbsp;
<b class="fc">&nbsp;                Page&lt;Item&gt; itemsPage = itemRepository.findByNameContainingIgnoreCaseOrDescriptionContainingIgnoreCaseAndAvailableIs(query, query, true, page);</b>
<b class="fc">&nbsp;                for (Item item : itemsPage.getContent()) {</b>
<b class="fc">&nbsp;                    listItemDto.add(ItemMapper.toItemDto(item));</b>
<b class="fc">&nbsp;                }</b>
<b class="fc">&nbsp;            }</b>
<b class="nc">&nbsp;        } else if ((from == null) &amp;&amp; (size == null)) {</b>
<b class="nc">&nbsp;            if (!query.isBlank()) {</b>
<b class="nc">&nbsp;                List&lt;Item&gt; items = itemRepository.findByNameContainingIgnoreCaseOrDescriptionContainingIgnoreCaseAndAvailableIs(query, query, true);</b>
<b class="nc">&nbsp;                for (Item item : items) {</b>
<b class="nc">&nbsp;                    listItemDto.add(ItemMapper.toItemDto(item));</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;Bad range for items!&quot;);</b>
<b class="nc">&nbsp;            throw new ValidationException(&quot;Bad range for items!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return listItemDto;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public CommentDto addComment(Long userId, Long itemId, CommentDto commentDto) {
<b class="fc">&nbsp;        User user = userService.getUser(userId);</b>
<b class="fc">&nbsp;        Item item = getItem(itemId);</b>
<b class="fc">&nbsp;        List&lt;Booking&gt; bookings = bookingRepository.findByItemAndBookerAndStatusEqualsAndStartIsBefore(item, user, Status.APPROVED, DateUtils.now());</b>
&nbsp;
<b class="fc">&nbsp;        if (bookings.size() &gt; 0) {</b>
<b class="fc">&nbsp;            if (commentDto.getText().isBlank()) {</b>
<b class="fc">&nbsp;                log.warn(&quot;Text of comment is empty!&quot;);</b>
<b class="fc">&nbsp;                throw new ValidationException(&quot;Text of comment is empty!&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            Comment comment = new Comment();</b>
&nbsp;
<b class="fc">&nbsp;            comment.setText(commentDto.getText());</b>
<b class="fc">&nbsp;            comment.setCreated(DateUtils.now());</b>
<b class="fc">&nbsp;            comment.setItem(item);</b>
<b class="fc">&nbsp;            comment.setAuthor(user);</b>
&nbsp;
<b class="fc">&nbsp;            Comment savedComment = commentRepository.save(comment);</b>
&nbsp;
<b class="fc">&nbsp;            CommentDto savedCommentDto = CommentMapper.toCommentDto(savedComment);</b>
&nbsp;
<b class="fc">&nbsp;            savedCommentDto.setAuthorName(user.getName());</b>
<b class="fc">&nbsp;            return savedCommentDto;</b>
&nbsp;        } else {
<b class="fc">&nbsp;            log.warn(&quot;No bookings!&quot;);</b>
<b class="fc">&nbsp;            throw new ValidationException(&quot;No bookings!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private BookingShortInfoDto findLastBooking(Item item) {
&nbsp;
<b class="fc">&nbsp;        List&lt;Booking&gt; bookings = bookingRepository.findByItemAndStartIsBeforeOrderByEndDesc(item, DateUtils.now());</b>
&nbsp;
<b class="fc">&nbsp;        if (bookings.size() &gt; 0) {</b>
<b class="nc">&nbsp;            Booking booking = bookings.get(0);</b>
<b class="nc">&nbsp;            System.out.println(booking);</b>
<b class="nc">&nbsp;            if (booking.getStatus() == Status.APPROVED) {</b>
<b class="nc">&nbsp;                BookingShortInfoDto lastBooking = new BookingShortInfoDto();</b>
<b class="nc">&nbsp;                lastBooking.setId(booking.getId());</b>
<b class="nc">&nbsp;                lastBooking.setBookerId(booking.getBooker().getId());</b>
&nbsp;
<b class="nc">&nbsp;                return lastBooking;</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private BookingShortInfoDto findNextBooking(Item item) {
<b class="fc">&nbsp;        List&lt;Booking&gt; bookings = bookingRepository.findByItemAndStartIsAfterOrderByStartAsc(item, DateUtils.now());</b>
&nbsp;
<b class="fc">&nbsp;        if (bookings.size() &gt; 0) {</b>
<b class="nc">&nbsp;            Booking booking = bookings.get(0);</b>
<b class="nc">&nbsp;            System.out.println(booking);</b>
&nbsp;
<b class="nc">&nbsp;            if (booking.getStatus() == Status.APPROVED) {</b>
<b class="nc">&nbsp;                BookingShortInfoDto nextBooking = new BookingShortInfoDto();</b>
<b class="nc">&nbsp;                nextBooking.setId(booking.getId());</b>
<b class="nc">&nbsp;                nextBooking.setBookerId(booking.getBooker().getId());</b>
&nbsp;
<b class="nc">&nbsp;                return nextBooking;</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-03-19 15:02</div>
</div>
</body>
</html>
